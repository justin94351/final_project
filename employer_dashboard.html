<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <title>Employer Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@latest/css/boxicons.min.css">
  </head>
  <body>
    <div class="wrapper">
      <h1>Employer Dashboard</h1>

      <!-- 職缺列表 -->
      <section>
        <h2 id="jobpost">My Job Post</h2>
        <table border="1" id="jobTable">
          <thead>
            <tr>
              <th>Job Id</th>
              <th>Title</th>
              <th>Location</th>
              <th>Salary</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- 用 JS 填資料 -->
          </tbody>
        </table>
      </section>

      <!-- 應徵者列表 -->
      <section>
        <h2 id="appTitle">Applicants</h2>
        <table border="1" id="appTable">
          <thead>
            <tr>
              <th>Application Id</th>
              <th>Job Id</th>
              <th>Applicant</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- 用 JS 填資料 -->
          </tbody>
        </table>
      </section>

      <!-- 新增 / 編輯職缺 -->
      <section>
        <h2 id="formTitle">Create New Job</h2>
        <form id="jobForm">
          <input type="hidden" id="jobId">

          <div class="input-box">
            <input type="text" id="title" placeholder="Title" required>
            <i class="bx bx-text"></i>
          </div>

          <div class="input-box">
            <input type="text" id="location" placeholder="Location" required>
            <i class="bx bx-map"></i>
          </div>

          <div class="input-box">
            <input type="number" id="salary" placeholder="Salary" required>
            <i class="bx bx-dollar"></i>
          </div>

          <div class="input-box">
            <textarea id="description" rows="3" placeholder="Description" required></textarea>
          </div>

          <div class="input-box">
            <select id="status" required>
              <option value="Open">Open</option>
              <option value="Closed">Closed</option>
            </select>
          </div>

          <div class="finalbtn">
            <button type="submit" id="submitBtn" class="btn">Create</button>
            <button type="button" id="cancelEditBtn" style="display:none; color:#fff" class="btn">Cancel</button>
            <button type="button" id="logoutBtn" class="btn">Logout</button>
          </div>
        </form>
      </section>
    </div>

    <script>
      // 1. 取得 token / role（如果你有做登入）
      const token = localStorage.getItem('token') || '';
      const role  = localStorage.getItem('role');

      // 如果你已經有 employer 的登入流程，可以打開這段：
      /*
      if (!token || role !== 'employer') {
        alert('You are not authorized to view this page.');
        window.location.href = 'login.html';
      }
      */

      // 2. 抓 DOM 元素
      const jobTableBody   = document.querySelector('#jobTable tbody');
      const jobForm        = document.getElementById('jobForm');
      const jobIdInput     = document.getElementById('jobId');
      const titleInput     = document.getElementById('title');
      const locationInput  = document.getElementById('location');
      const salaryInput    = document.getElementById('salary');
      const descInput      = document.getElementById('description');
      const statusSelect   = document.getElementById('status');

      const formTitle      = document.getElementById('formTitle');
      const submitBtn      = document.getElementById('submitBtn');
      const cancelEditBtn  = document.getElementById('cancelEditBtn');
      const logoutBtn      = document.getElementById('logoutBtn');

      const appTableBody   = document.querySelector('#appTable tbody');
      const appTitle       = document.getElementById('appTitle');
      let currentJobId     = null;   // 目前正在查看應徵者的 job_id

      // 3. 登出
      logoutBtn.addEventListener('click', () => {
        localStorage.clear();
        window.location.href = 'login.html';
      });

      // 4. 載入職缺列表 (Read all jobs)
      async function loadJobs() {
        jobTableBody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';

        try {
          const res = await fetch('/api/employer/jobs', {
            headers: {
              'Authorization': token ? `Bearer ${token}` : ''
            }
          });

          if (!res.ok) throw new Error('Failed to fetch jobs');

          const jobs = await res.json();

          if (!jobs || jobs.length === 0) {
            jobTableBody.innerHTML = '<tr><td colspan="6">No jobs yet.</td></tr>';
            return;
          }

          jobTableBody.innerHTML = '';
          jobs.forEach(job => {
            const tr = document.createElement('tr');

            // 假設後端回傳欄位：id / title / location / salary / status
            tr.innerHTML = `
              <td>${job.id}</td>
              <td>${job.title}</td>
              <td>${job.location}</td>
              <td>${job.salary}</td>
              <td>${job.status}</td>
              <td>
                <button class="editBtn" data-id="${job.id}">Edit</button>
                <button class="deleteBtn" data-id="${job.id}">Delete</button>
                <button class="viewAppsBtn" data-id="${job.id}">Applicants</button>
              </td>
            `;

            jobTableBody.appendChild(tr);
          });

          // 綁定 edit / delete / applicants 按鈕事件
          document.querySelectorAll('.editBtn').forEach(btn => {
            btn.addEventListener('click', () => startEdit(btn.dataset.id));
          });

          document.querySelectorAll('.deleteBtn').forEach(btn => {
            btn.addEventListener('click', () => deleteJob(btn.dataset.id));
          });

          document.querySelectorAll('.viewAppsBtn').forEach(btn => {
            btn.addEventListener('click', () => loadApplicants(btn.dataset.id));
          });

        } catch (err) {
          console.error(err);
          jobTableBody.innerHTML = '<tr><td colspan="6">Error loading jobs.</td></tr>';
        }
      }

      // 5. 新增 / 更新職缺 (Create / Update)
      jobForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const jobData = {
          title:       titleInput.value.trim(),
          location:    locationInput.value.trim(),
          salary:      Number(salaryInput.value),
          description: descInput.value.trim(),
          status:      statusSelect.value
        };

        const jobId = jobIdInput.value;

        try {
          let res;
          if (jobId) {
            // Update
            res = await fetch(`/api/employer/jobs/${jobId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
              },
              body: JSON.stringify(jobData)
            });
          } else {
            // Create
            res = await fetch('/api/employer/jobs', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
              },
              body: JSON.stringify(jobData)
            });
          }

          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            alert(data.message || 'Error saving job');
            return;
          }

          alert(jobId ? 'Job updated!' : 'Job created!');
          resetForm();
          loadJobs();

        } catch (err) {
          console.error(err);
          alert('Network error');
        }
      });

      // 6. 刪除職缺 (Delete)
      async function deleteJob(id) {
        if (!confirm('Delete this job?')) return;

        try {
          const res = await fetch(`/api/employer/jobs/${id}`, {
            method: 'DELETE',
            headers: {
              'Authorization': token ? `Bearer ${token}` : ''
            }
          });

          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            alert(data.message || 'Failed to delete');
            return;
          }

          alert('Deleted!');
          loadJobs();

          // 如果正在看這個 job 的 applicants，就清空列表
          if (currentJobId === id) {
            currentJobId = null;
            appTitle.textContent = 'Applicants';
            appTableBody.innerHTML = '<tr><td colspan="5">No job selected.</td></tr>';
          }

        } catch (err) {
          console.error(err);
          alert('Network error');
        }
      }

      // 7. 開始編輯 (讀單一職缺 + 填入表單)
      async function startEdit(id) {
        try {
          const res = await fetch(`/api/employer/jobs/${id}`, {
            headers: {
              'Authorization': token ? `Bearer ${token}` : ''
            }
          });

          if (!res.ok) throw new Error('Failed to load job');

          const job = await res.json();

          jobIdInput.value     = job.id;
          titleInput.value     = job.title;
          locationInput.value  = job.location;
          salaryInput.value    = job.salary;
          descInput.value      = job.description;
          statusSelect.value   = job.status || 'Open';

          formTitle.textContent = 'Edit Job';
          submitBtn.textContent = 'Update';
          cancelEditBtn.style.display = 'inline-block';

        } catch (err) {
          console.error(err);
          alert('Error loading job for edit');
        }
      }

      // 8. 載入某職缺的應徵者列表
      async function loadApplicants(jobId) {
        currentJobId = jobId;
        appTitle.textContent = `Applicants for Job ${jobId}`;
        appTableBody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';

        try {
          const res = await fetch(`/api/employer/jobs/${jobId}/applications`, {
            headers: {
              'Authorization': token ? `Bearer ${token}` : ''
            }
          });

          if (!res.ok) {
            throw new Error('Failed to fetch applicants');
          }

          const apps = await res.json();

          if (!apps || apps.length === 0) {
            appTableBody.innerHTML = '<tr><td colspan="5">No applicants yet.</td></tr>';
            return;
          }

          appTableBody.innerHTML = '';
          apps.forEach(app => {
            const tr = document.createElement('tr');

            // 假設後端回傳欄位：application_id / job_id / applicant_name / application_status
            tr.innerHTML = `
              <td>${app.application_id}</td>
              <td>${app.job_id}</td>
              <td>${app.applicant_name || ''}</td>
              <td>${app.application_status}</td>
              <td>
                <button class="acceptBtn" data-app-id="${app.application_id}">Accept</button>
                <button class="rejectBtn" data-app-id="${app.application_id}">Reject</button>
              </td>
            `;

            appTableBody.appendChild(tr);
          });

          // 綁定 Accept / Reject 按鈕事件
          document.querySelectorAll('.acceptBtn').forEach(btn => {
            btn.addEventListener('click', () =>
              updateApplicationStatus(btn.dataset.appId, 'Accepted')
            );
          });

          document.querySelectorAll('.rejectBtn').forEach(btn => {
            btn.addEventListener('click', () =>
              updateApplicationStatus(btn.dataset.appId, 'Rejected')
            );
          });

        } catch (err) {
          console.error(err);
          appTableBody.innerHTML = '<tr><td colspan="5">Error loading applicants.</td></tr>';
        }
      }

      // 9. 更新某申請的狀態 (Accepted / Rejected)
      async function updateApplicationStatus(applicationId, newStatus) {
        if (!confirm(`Set this application to "${newStatus}"?`)) return;

        try {
          const res = await fetch(`/api/employer/applications/${applicationId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': token ? `Bearer ${token}` : ''
            },
            body: JSON.stringify({ status: newStatus })
          });

          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            alert(data.message || 'Failed to update application status');
            return;
          }

          alert(`Application set to ${newStatus}`);
          if (currentJobId) {
            loadApplicants(currentJobId); // 更新當前職缺的 applicant 列表
          }

        } catch (err) {
          console.error(err);
          alert('Network error');
        }
      }

      // 10. 取消編輯 & 重設表單
      function resetForm() {
        jobIdInput.value     = '';
        titleInput.value     = '';
        locationInput.value  = '';
        salaryInput.value    = '';
        descInput.value      = '';
        statusSelect.value   = 'Open';

        formTitle.textContent = 'Create New Job';
        submitBtn.textContent = 'Create';
        cancelEditBtn.style.display = 'none';
      }

      cancelEditBtn.addEventListener('click', resetForm);

      // 11. 頁面載入時，先載入職缺
      loadJobs();
    </script>
  </body>
</html>
